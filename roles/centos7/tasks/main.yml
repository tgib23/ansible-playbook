---

- name: download epel
  get_url:
    url: http://ftp.jaist.ac.jp/pub/Linux/Fedora/epel//7/x86_64/e/epel-release-7-9.noarch.rpm
    dest: /tmp

- name: update epel
  yum:
    name: /tmp/epel-release-7-9.noarch.rpm
    state: present

- name: import rpm key
  rpm_key:
    state: present
    key: http://package.mapr.com/releases/pub/maprgpg.key

- name: copy repo file
  copy: src=v{{ mapr_version}}.maprtech.repo dest=/etc/yum.repos.d/maprtech.repo

- name: copy disks
  copy: src=disks dest=/tmp/disks

- name: install mapr packages
  yum: name={{ item }} state=installed
  with_items:
    - mapr-cldb
    - mapr-core
    - mapr-fileserver
    - mapr-zookeeper
    - mapr-zk-internal
    - mapr-webserver
    - java-devel
    - clustershell

- name: add JAVA_HOME
  lineinfile:
    dest: '/opt/mapr/conf/env.sh'
    regexp: '^#export JAVA_HOME='
    backrefs: yes
    line: 'export JAVA_HOME=/usr/lib/jvm/jre-1.8.0'
    state: present

- name: copy clustershell group setting template
  copy: src=groups dest=/etc/clustershell/groups

- name: configure clustershell group
  replace:
    dest='/etc/clustershell/groups'
    regexp='CLUSTERSHELLNODES'
    replace='{{ clush_nodes }}'

- name: configure.sh
  shell: /opt/mapr/server/configure.sh -C '{{ cldb_nodes }}' -Z '{{ zookeeper_nodes }}' -N '{{ cluster_name }}'

- name: disksetup
  shell: /opt/mapr/server/disksetup -F /tmp/disks
  when: diskadd == 'true'

- name: add core-site.xml
  copy: src=core-site.xml dest=/opt/mapr/hadoop/hadoop-2.7.0/etc/hadoop/core-site.xml owner=mapr

- name: run the service
  service: name={{ item }} state=started
  with_items:
    - mapr-zookeeper
    - mapr-warden
